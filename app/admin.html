<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin — VeriSure</title>

    <link rel="stylesheet" href="../assets/css/base.css">
    <link rel="stylesheet" href="../assets/css/layout.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
</head>

<body>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="brand">VeriSure</div>
            <nav class="side-links">
                <a href="./admin.html" class="active">Platform Overview</a>
                <a href="./admin-issuers.html">Issuers</a>
                <a href="./admin-users.html">Users</a>
                <a href="./admin-logs.html">Activity Logs</a>
                <a href="./admin-metrics.html">System Metrics</a>
            </nav>
            <div class="hr"></div>
            <button class="btn" data-action="logout">Logout</button>
        </aside>

        <main class="main">
            <div class="topbar">
                <div class="page-title">
                    <h1>Platform Overview</h1>
                    <p>Guard the gates. Never touch the ledger.</p>
                </div>
            </div>

            <div id="banner"></div>

            <div class="grid-4">
                <section class="card kpi">
                    <div class="label">Pending Issuers</div>
                    <div class="value" id="kPending">0</div>
                </section>
                <section class="card kpi">
                    <div class="label">Approved Issuers</div>
                    <div class="value" id="kApproved">0</div>
                </section>
                <section class="card kpi">
                    <div class="label">Suspended Issuers</div>
                    <div class="value" id="kSuspended">0</div>
                </section>
                <section class="card kpi">
                    <div class="label">Total Issuers</div>
                    <div class="value" id="kTotal">0</div>
                </section>
            </div>

            <div style="height:14px"></div>

            <section class="card">
                <h3 style="margin:0 0 10px;">Recent Issuer Applications</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Entity ID</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Country</th>
                        </tr>
                    </thead>
                    <tbody id="recentRows"></tbody>
                </table>
            </section>

            <div style="height:14px"></div>

            <section class="card">
                <h3 style="margin:0 0 10px;">Quick Actions</h3>
                <div class="controls">
                    <a class="btn primary" href="./admin-issuers.html">Manage Issuers</a>
                    <a class="btn" href="./admin-users.html">View Users</a>
                    <a class="btn" href="./admin-logs.html">View Logs</a>
                    <a class="btn" href="./admin-metrics.html">System Metrics</a>
                </div>
            </section>
        </main>
    </div>

    <script src="../js/app.js"></script>
    <script>
        (function () {
            const s = Session.get();
            if (!s || s.role !== "admin") {
                showBanner("error", "Unauthorized");
                return setTimeout(() => Session.clear(), 600);
            }

            async function load() {
                try {
                    const r = await fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
                        body: new URLSearchParams({ action: "listIssuers" }).toString()
                    });
                    const text = await r.text();
                    const data = JSON.parse(text);

                    if (data.error) throw new Error(data.error);

                    const issuers = Array.isArray(data.issuers) ? data.issuers : [];
                    const pending = issuers.filter(i => i.status === "pending").length;
                    const approved = issuers.filter(i => i.status === "approved").length;
                    const suspended = issuers.filter(i => i.status === "suspended").length;

                    document.getElementById("kPending").textContent = String(pending);
                    document.getElementById("kApproved").textContent = String(approved);
                    document.getElementById("kSuspended").textContent = String(suspended);
                    document.getElementById("kTotal").textContent = String(issuers.length);

                    const rows = document.getElementById("recentRows");
                    const top = issuers.slice(0, 8);

                    rows.innerHTML = top.length
                        ? top.map(i => `
              <tr>
                <td><span class="mono">${i.id}</span></td>
                <td>${i.name}</td>
                <td>${i.status}</td>
                <td>${i.country || "—"}</td>
              </tr>
            `).join("")
                        : `<tr><td colspan="4" class="notice">No issuers found.</td></tr>`;
                } catch (e) {
                    showBanner("error", e.message || "Failed to load overview.");
                }
            }

            load();
        })();
    </script>
</body>

</html>