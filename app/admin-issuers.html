<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Issuers — Admin — VeriSure</title>

    <link rel="stylesheet" href="../assets/css/base.css">
    <link rel="stylesheet" href="../assets/css/layout.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
</head>

<body>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="brand">VeriSure</div>
            <nav class="side-links">
                <a href="./admin.html">Platform Overview</a>
                <a href="./admin-issuers.html" class="active">Issuers</a>
                <a href="./admin-users.html">Users</a>
                <a href="./admin-logs.html">Activity Logs</a>
                <a href="./admin-metrics.html">System Metrics</a>
            </nav>
            <div class="hr"></div>
            <button class="btn" data-action="logout">Logout</button>
        </aside>

        <main class="main">
            <div class="topbar">
                <div class="page-title">
                    <h1>Issuers</h1>
                    <p>Approve or suspend issuer access. Existing credentials remain verifiable.</p>
                </div>
            </div>

            <div id="banner"></div>

            <section class="card">
                <div class="controls">
                    <input id="q" class="input" placeholder="Search by name or entity ID">
                    <select id="statusFilter" class="select">
                        <option value="">All statuses</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="suspended">Suspended</option>
                    </select>
                    <button class="btn" id="refreshBtn">Refresh</button>
                </div>

                <div style="height:12px;"></div>
                <div id="tableWrap"></div>
            </section>

            <div id="vs-modal" class="vs-modal-wrap hidden">
                <div class="vs-modal">
                    <h3 id="vs-modal-title">Confirm</h3>
                    <p id="vs-modal-msg"></p>
                    <div class="vs-modal-actions">
                        <button id="vs-modal-cancel" class="btn">Cancel</button>
                        <button id="vs-modal-ok" class="btn primary">Confirm</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/app.js"></script>
    <script src="../js/dashboard.js"></script>
    <script>
        const state = { all: [], filtered: [] };

        function escapeHtml(s) {
            return String(s ?? "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
        }

        function pill(status) {
            if (status === "approved") return `<span class="badge good">approved</span>`;
            if (status === "pending") return `<span class="badge warn">pending</span>`;
            if (status === "suspended") return `<span class="badge bad">suspended</span>`;
            return `<span class="badge">${escapeHtml(status || "unknown")}</span>`;
        }

        async function api(payload) {
            const r = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
                body: new URLSearchParams(payload).toString()
            });
            const t = await r.text();
            try { return JSON.parse(t); } catch { return { error: "Invalid JSON response", raw: t }; }
        }

        function applyFilters() {
            const q = (document.getElementById("q").value || "").trim().toLowerCase();
            const st = (document.getElementById("statusFilter").value || "").trim().toLowerCase();

            state.filtered = state.all.filter(x => {
                const matchesQ =
                    !q ||
                    String(x.name || "").toLowerCase().includes(q) ||
                    String(x.id || "").toLowerCase().includes(q);

                const matchesSt = !st || String(x.status || "").toLowerCase() === st;
                return matchesQ && matchesSt;
            });

            renderTable();
        }

        function renderTable() {
            const wrap = document.getElementById("tableWrap");
            const rows = state.filtered;

            if (!rows.length) {
                wrap.innerHTML = `<div class="empty">No issuers match your filters.</div>`;
                return;
            }

            wrap.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Entity ID</th>
              <th>Name</th>
              <th>Status</th>
              <th>Country</th>
              <th style="width:260px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td class="mono">${escapeHtml(r.id)}</td>
                <td>${escapeHtml(r.name)}</td>
                <td>${pill(String(r.status || "").toLowerCase())}</td>
                <td>${escapeHtml(r.country || "—")}</td>
                <td>
                  <div class="controls" style="margin:0;">
                    <button class="btn primary" ${r.status === "approved" ? "disabled" : ""} data-action="approve" data-id="${escapeHtml(r.id)}">Approve</button>
                    <button class="btn" ${r.status === "suspended" ? "disabled" : ""} data-action="suspend" data-id="${escapeHtml(r.id)}">Suspend</button>
                  </div>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
        }

        async function loadIssuers() {
            const data = await api({ action: "listIssuers" });
            if (data.error) throw new Error(data.error);

            state.all = Array.isArray(data.issuers) ? data.issuers : [];
            state.filtered = [...state.all];
            renderTable();
        }

        async function changeStatus(entityId, action, label) {
            openConfirmModal({
                title: `${label} issuer`,
                message: `Are you sure you want to ${label.toLowerCase()} this issuer?`,
                confirmText: label,
                onConfirm: async () => {
                    const data = await api({ action, entity_id: entityId });
                    if (data.error) throw new Error(data.error);
                    showBanner("success", `Issuer ${label.toLowerCase()}d successfully.`);
                    await loadIssuers();
                    applyFilters();
                }
            });
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const s = Session.get();
            if (!s || s.role !== "admin") return Session.clear();

            document.getElementById("q").addEventListener("input", applyFilters);
            document.getElementById("statusFilter").addEventListener("change", applyFilters);
            document.getElementById("refreshBtn").addEventListener("click", async () => {
                try {
                    await loadIssuers();
                    applyFilters();
                    showBanner("success", "Refreshed");
                } catch (e) {
                    showBanner("error", e.message || "Refresh failed");
                }
            });

            document.getElementById("tableWrap").addEventListener("click", (e) => {
                const btn = e.target.closest("button[data-action][data-id]");
                if (!btn) return;

                const entityId = btn.dataset.id;
                const action = btn.dataset.action;

                if (action === "approve") {
                    changeStatus(entityId, "approveIssuer", "Approve");
                } else if (action === "suspend") {
                    changeStatus(entityId, "suspendIssuer", "Suspend");
                }
            });

            try {
                await loadIssuers();
                applyFilters();
            } catch (e) {
                showBanner("error", e.message || "Failed to load issuers");
            }
        });
    </script>
</body>

</html>