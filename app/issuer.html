<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Issuer Dashboard — VeriSure</title>

    <link rel="stylesheet" href="../assets/css/base.css">
    <link rel="stylesheet" href="../assets/css/layout.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
</head>

<body onload="protect();">
    <div class="dashboard">
        <aside class="sidebar">
            <div class="brand">VeriSure</div>
            <nav class="side-links">
                <a href="./issuer.html" class="active">Overview</a>
                <a href="./issue.html">Issue Credential</a>
                <a href="./issued.html">Issued Credentials</a>
                <a href="./issuer-logs.html">Activity & Logs</a>
                <a href="./issuer-settings.html">Issuer Settings</a>
            </nav>
            <div class="hr"></div>
            <button class="btn" type="button" onclick="Session.clear()">Logout</button>
        </aside>

        <main class="main">
            <div class="topbar">
                <div class="page-title">
                    <h1>Overview</h1>
                    <p id="subline">Issuer overview and activity snapshot.</p>
                </div>

                <div class="controls" style="margin:0; gap:10px;">
                    <button class="btn" type="button" id="refreshBtn">Refresh</button>
                </div>
            </div>

            <div id="banner"></div>

            <section class="card">
                <div class="grid-4">
                    <div class="kpi">
                        <div class="label">Total issued</div>
                        <div class="value" id="k_issued">—</div>
                    </div>
                    <div class="kpi">
                        <div class="label">Active</div>
                        <div class="value" id="k_active">—</div>
                    </div>
                    <div class="kpi">
                        <div class="label">Revoked / Frozen</div>
                        <div class="value" id="k_rf">—</div>
                    </div>
                    <div class="kpi">
                        <div class="label">Verifications (30d)</div>
                        <div class="value" id="k_v30">—</div>
                    </div>
                </div>

                <div style="height:12px;"></div>
                <div class="hr"></div>

                <div class="controls" style="justify-content:space-between; align-items:center;">
                    <div class="notice">
                        <div><b id="issuerName">—</b></div>
                        <div style="opacity:.8;">
                            Status: <span id="issuerStatus">—</span>
                        </div>
                    </div>

                    <div class="controls" style="margin:0;">
                        <a class="btn primary" href="./issue.html">Issue credential</a>
                        <a class="btn" href="./issued.html">View registry</a>
                    </div>
                </div>

                <div style="height:8px;"></div>
                <div class="notice" style="opacity:.85;">
                    Note: KPI values require an <span class="mono">issuer_overview</span> endpoint (optional). This page
                    currently shows status and basic context.
                </div>
            </section>
        </main>
    </div>

    <script src="../js/app.js"></script>
    <script src="../js/dashboard.js"></script>

    <script>
        (function () {

            /* =========================
               Session guard
            ========================= */

            const session = Session.get();
            if (!session || session.role !== "issuer") {
                Session.clear();
                location.href = "../login.html";
                return;
            }

            if (typeof setActiveSidebar === "function") setActiveSidebar("./issuer.html");

            const refreshBtn = document.getElementById("refreshBtn");

            /* =========================
               Network
            ========================= */

            async function postForm(payload) {
                const r = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
                    body: new URLSearchParams(payload).toString()
                });

                const text = await r.text();
                try { return JSON.parse(text); }
                catch { return { error: "Invalid JSON response", raw: text }; }
            }

            /* =========================
               UI helpers
            ========================= */

            function setText(id, val) {
                const el = document.getElementById(id);
                if (!el) return;
                el.textContent = (val === undefined || val === null || val === "") ? "—" : String(val);
            }

            function setLoading(on) {
                if (!refreshBtn) return;
                refreshBtn.disabled = !!on;
                refreshBtn.textContent = on ? "Refreshing…" : "Refresh";
            }

            function updateSessionIssuer_(issuerName, issuerStatus) {
                try {
                    const next = Object.assign({}, session, {
                        issuerName: issuerName || session.issuerName || "",
                        issuerStatus: issuerStatus || session.issuerStatus || ""
                    });
                    Session.set(next);
                } catch { }
            }

            /* =========================
               Data
            ========================= */

            async function loadOverview() {
                if (!session.entityId) {
                    showBanner("error", "Issuer entityId missing. Please log in again.");
                    return;
                }

                setLoading(true);

                const res = await postForm({ action: "issuer_status", entity_id: session.entityId });

                if (res && res.error) {
                    showBanner("error", typeof res.error === "string" ? res.error : (res.message || "Failed to load issuer status."));
                    setLoading(false);
                    return;
                }

                const issuerName = res.issuerName || session.issuerName || "—";
                const issuerStatus = res.issuerStatus || session.issuerStatus || "—";

                setText("issuerName", issuerName);
                setText("issuerStatus", issuerStatus);

                updateSessionIssuer_(res.issuerName, res.issuerStatus);

                setText("k_issued", "—");
                setText("k_active", "—");
                setText("k_rf", "—");
                setText("k_v30", "—");

                const sub = document.getElementById("subline");
                if (sub) sub.textContent = `Issuer overview for ${res.issuerName || "your institution"}.`;

                setLoading(false);

                if (typeof lockIssuerUntilApproved === "function") lockIssuerUntilApproved();
            }

            if (refreshBtn) refreshBtn.addEventListener("click", loadOverview);

            loadOverview();
        })();
    </script>
</body>

</html>